/*!
 * complete - Autocomplete Plugin
 * v0.8.0
 * https://github.com/firstandthird/complete
 * copyright First+Third 2014
 * MIT License
*/
!function(a){function b(a){return a.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")}a.declare("complete",{defaults:{search:function(a,b,c){return-1!==this._getSuggestion(a).toLowerCase().indexOf(c.toLowerCase())},listClass:"complete",suggestionActiveClass:"complete-active",suggestionClass:"complete-suggestion",maxHeight:142,listWidth:!1,minChars:0,zIndex:99999,delay:300,allowOthers:!1,sourceKey:null,showOnClick:!0,keepOpen:!1,formatSuggestion:function(a,c){var d="("+b(c)+")";return this._getSuggestion(a).replace(new RegExp(d,"gi"),"<strong>$1</strong>")},query:function(b,c){var d=b.toLowerCase(),e=this,f=a.grep(this.source,function(a){return e.search(a,b,d)});c.call(this,f)}},events:{keydown:"keyPressed",keyup:"keyUp",blur:"onBlur",focus:"onFocus",click:"valueChanged"},keyCode:{UP:38,DOWN:40,TAB:9,ENTER:13,ESC:27},init:function(){a(this.el).attr("autocomplete","off"),this.createListHolder(),this.visible=!1,this.currentValue=this.el.value,this.selectedIndex=-1,this.suggestions=[]},_getSuggestion:function(a){var b;return b=this.sourceKey&&a&&a[this.sourceKey]?a[this.sourceKey]:a},debounce:function(a){var b=this,c=arguments;this.delay>0?(clearTimeout(this.debounceTimeout),this.debounceTimeout=setTimeout(function(){a.apply(b,c)},this.delay)):a.apply(this,c)},createListHolder:function(){var b=a(this.el);this.listHolder=a("<div>").addClass(this.listClass).hide().insertAfter(b),this.list=a("<ul>"),this.list.appendTo(this.listHolder),a(this.listHolder).css({width:this.listWidth||b.outerWidth(),top:b.position().top+b.outerHeight(),left:b.position().left,"max-height":this.maxHeight,"z-index":this.zIndex}),this.bindEventsList()},updatePosition:function(){var b=a(this.el);a(this.listHolder).css({top:b.position().top+b.outerHeight(),left:b.position().left})},bindEventsList:function(){var b=a(this.list),c=this;b.on("mouseover","li",function(a){var b=c._getTarget(a);c.activateSuggestion.apply(c,[b.data("index")])}),b.on("mouseout","li",this.proxy(this.deActivateSuggestion,this)),b.on("click","li",this.proxy(this.selectSuggestion,this))},keyPressed:function(a){var b=!0;switch(a.keyCode){case this.keyCode.UP:this._prevSuggestion();break;case this.keyCode.DOWN:this._nextSuggestion();break;case this.keyCode.ESC:this.el.val(this.currentValue),this.hide();break;case this.keyCode.TAB:case this.keyCode.ENTER:b=!1,this.selectSuggestion(a);break;default:return}b||(a.stopImmediatePropagation(),a.preventDefault())},keyUp:function(a){switch(a.keyCode){case this.keyCode.UP:case this.keyCode.DOWN:case this.keyCode.ENTER:return}this._generatedSuggestions=!1,this.debounce(this.valueChanged)},onBlur:function(){a(document).on("click.complete",this.proxy(this.onClickWA,this))},onFocus:function(){this.updatePosition()},onClickWA:function(b){this.keepOpen||0!==a(b.target).closest("."+this.listClass).length?this.emit("complete:outsideclick"):(this.hide(),a(document).off("click.complete"))},valueChanged:function(b){(this._getSuggestion(this.currentValue)!==a(this.el).val()||"undefined"!=typeof b&&this.showOnClick)&&(this.el.value=a.trim(a(this.el).val()),this.currentValue=this.el.value,this.selectedIndex=-1,this.currentValue.length>=this.minChars?this.show():this.hide()),this._generatedSuggestions=!0},_getSuggestions:function(b){var c=b.toLowerCase(),d=this;return a.grep(this.source,function(a){return d.search(a,b,c)})},_nextSuggestion:function(){var a=this.selectedIndex;!this.visible&&this.currentValue?this.show():a!==this.suggestions.length-1&&this._adjustPosition(a+1)},_prevSuggestion:function(){var a=this.selectedIndex;-1!==a&&this._adjustPosition(a-1)},_adjustPosition:function(b){var c,d,e,f,g=this.activateSuggestion(b),h=a(this.listHolder);g&&(c=g.offsetTop,d=h.scrollTop(),f=a(this.list).children().first().outerHeight(),e=d+this.maxHeight-f,d>c?h.scrollTop(c):c>e&&h.scrollTop(c-this.maxHeight+f),a(this.el).val(this._getSuggestion(this.suggestions[b])))},hide:function(){this.visible=!1,a(this.listHolder).hide()},show:function(){var b=this;this.query.call(b,this.currentValue,function(c){if(b.emit("complete:query",c),c&&a.isArray(c)&&c.length){b.visible=!0;var d=b.currentValue,e=b.suggestionClass,f="";b.suggestions=[],b.suggestions=c,a.each(c,function(a,c){f+='<li class="'+e+'" data-index="'+a+'">'+b.formatSuggestion(c,d)+"</li>"}),a(b.list).html(f),a(b.listHolder).show()}else a(b.list).empty(),b.suggestions=[],b.hide()})},activateSuggestion:function(b){var c=this.suggestionActiveClass,d=a(this.list);return d.children("."+c).removeClass(c),this.selectedIndex=b,-1!==b&&d.children().length>b?a(d.children().get(b)).addClass(c):void 0},deActivateSuggestion:function(a){this._getTarget(a).removeClass(this.suggestionActiveClass),this.selectedIndex=-1},selectSuggestion:function(b){if(this._generatedSuggestions||this.valueChanged(),"keydown"===b.type&&this.allowOthers&&this.selectedIndex<0){var c=this._getSuggestion(this.suggestions[0]);1===this.suggestions.length&&c===this.currentValue?(this.currentValue=this.suggestions[0],a(this.el).val(this._getSuggestion(this.currentValue))):a(this.el).val(this.currentValue),this.emit("complete:select",this.currentValue),this.hide()}else-1===this.selectedIndex&&(this.selectedIndex=0),this.suggestions[this.selectedIndex]&&(a(this.el).val(this._getSuggestion(this.suggestions[this.selectedIndex])),this.currentValue=this.suggestions[this.selectedIndex],this.emit("complete:select",this.currentValue),this.hide())},_getTarget:function(b){return a(b.currentTarget||b.toElement)},setSource:function(a){this.source=a}})}(jQuery);